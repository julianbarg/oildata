---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.6.0
  kernelspec:
    display_name: R
    language: R
    name: ir
---

<!-- #region slideshow={"slide_type": "slide"} -->
# Create Topic Model for Incidents
<!-- #endregion -->

```{r execution={'iopub.execute_input': '2020-10-26T19:12:41.562356Z', 'iopub.status.busy': '2020-10-26T19:12:41.559406Z', 'iopub.status.idle': '2020-10-26T19:12:44.581989Z', 'shell.execute_reply': '2020-10-26T19:12:44.458026Z'}}
suppressMessages(library(here))
suppressMessages(library(tidyverse))
library(tidytext)
library(SnowballC)
library(topicmodels)
library(ldatuning)
library(here)

assets <- purrr::partial(here, "data-raw", "util", "assets")
data_folder <- purrr::partial(here, "data-raw", ".temp", "data")
```

<!-- #region slideshow={"slide_type": "subslide"} -->
Used data as of Oct 12, 2020.

Original exploration can be found at: https://julianbarg.github.io/spills/inquiries/incident_variance/2020-08-03.slides.html#/
<!-- #endregion -->

```{r execution={'iopub.execute_input': '2020-10-26T19:12:44.625906Z', 'iopub.status.busy': '2020-10-26T19:12:44.590134Z', 'iopub.status.idle': '2020-10-26T19:12:44.701965Z', 'shell.execute_reply': '2020-10-26T19:12:44.700659Z'}}
# incidents <- readRDS(data_folder("incidents_merged.rds"))
# readr::write_rds(
#   select(incidents, incident_ID, ID, name, on_offshore, commodity, year,
#          narrative),
#   assets("narratives.rds"))
narratives <- readRDS(assets("narratives.rds"))
head(narratives)
```

<!-- #region slideshow={"slide_type": "subslide"} -->
### We want to grab the company names, so we can remove those from the dataset
<!-- #endregion -->

```{r execution={'iopub.execute_input': '2020-10-26T19:12:44.711119Z', 'iopub.status.busy': '2020-10-26T19:12:44.709895Z', 'iopub.status.idle': '2020-10-26T19:12:44.919071Z', 'shell.execute_reply': '2020-10-26T19:12:44.917877Z'}}
company_names <- unique(word(narratives$name, 1))
paste(company_names, collapse = ", ")
```

<!-- #region slideshow={"slide_type": "subslide"} -->
Limite data set to observation period and only retain relevant columns.
<!-- #endregion -->

<!-- #region slideshow={"slide_type": "slide"} -->
## Create document-term matrix
<!-- #endregion -->

```{r execution={'iopub.execute_input': '2020-10-26T19:12:44.926390Z', 'iopub.status.busy': '2020-10-26T19:12:44.924858Z', 'iopub.status.idle': '2020-10-26T19:12:44.943043Z', 'shell.execute_reply': '2020-10-26T19:12:44.938850Z'}, slideshow={'slide_type': 'subslide'}}
narratives <- subset(narratives, on_offshore == "onshore" 
                     & commodity %in% c("rpp", "crude") 
                     & year >= 2004 & year < 2020 
                     & !is.na(narrative))
```

```{r execution={'iopub.execute_input': '2020-10-26T19:12:44.948104Z', 'iopub.status.busy': '2020-10-26T19:12:44.946518Z', 'iopub.status.idle': '2020-10-26T19:12:50.961269Z', 'shell.execute_reply': '2020-10-26T19:12:50.960709Z'}}
word_counts <- narratives %>%
    unnest_tokens(word, narrative) %>%
    anti_join(data.frame(word = str_to_lower(company_names)), by = "word") %>%
    anti_join(stop_words, by = "word") %>%
    filter(! str_detect(word, "^[0-9]")) %>%
    mutate(word = wordStem(word)) %>%
    count(incident_ID, word, sort = T) %>%
    cast_dtm(document = incident_ID, term = word, 
             value = n)
word_counts
```

<!-- #region slideshow={"slide_type": "slide"} -->
## Run topicmodels
Models based on data as of Oct 12, 2020.
<!-- #endregion -->

```{r execution={'iopub.execute_input': '2020-10-26T19:12:50.969447Z', 'iopub.status.busy': '2020-10-26T19:12:50.967430Z', 'iopub.status.idle': '2020-10-26T19:12:50.984366Z', 'shell.execute_reply': '2020-10-26T19:12:50.982938Z'}, slideshow={'slide_type': 'subslide'}}
# results_1 <- FindTopicsNumber(word_counts, 
#                               topics = c(5, 10, 20, 40, 80, 120, 160), 
#                               metrics = c("Griffiths2004", "CaoJuan2009", "Arun2010", "Deveaud2014"),
#                               method = "Gibbs", 
#                               control = list(seed = 532))
# saveRDS(results_1, file = assets("results_1.rds"))
results_1 <- readRDS(assets("results_1.rds"))
```

```{r execution={'iopub.execute_input': '2020-10-26T19:12:51.000802Z', 'iopub.status.busy': '2020-10-26T19:12:51.000066Z', 'iopub.status.idle': '2020-10-26T19:12:52.158445Z', 'shell.execute_reply': '2020-10-26T19:12:52.157011Z'}, slideshow={'slide_type': 'subslide'}}
FindTopicsNumber_plot(results_1)
```

```{r execution={'iopub.execute_input': '2020-10-26T19:12:52.163768Z', 'iopub.status.busy': '2020-10-26T19:12:52.162363Z', 'iopub.status.idle': '2020-10-26T19:12:52.177266Z', 'shell.execute_reply': '2020-10-26T19:12:52.175869Z'}, slideshow={'slide_type': 'subslide'}}
# results_2 <- FindTopicsNumber(word_counts, 
#                             topics = c(15, 18, 19, 20, 21, 22, 25), 
#                             metrics = c("Griffiths2004", "CaoJuan2009", "Arun2010", "Deveaud2014"),
#                             method = "Gibbs", 
#                             control = list(seed = 544))
# saveRDS(results_2, file = assets("results_2.rds"))
results_2 <- readRDS(assets("results_2.rds"))
```

```{r execution={'iopub.execute_input': '2020-10-26T19:12:52.188215Z', 'iopub.status.busy': '2020-10-26T19:12:52.187027Z', 'iopub.status.idle': '2020-10-26T19:12:52.765365Z', 'shell.execute_reply': '2020-10-26T19:12:52.763786Z'}, slideshow={'slide_type': 'subslide'}}
FindTopicsNumber_plot(results_2)
```

```{r execution={'iopub.execute_input': '2020-10-26T19:12:52.775942Z', 'iopub.status.busy': '2020-10-26T19:12:52.769189Z', 'iopub.status.idle': '2020-10-26T19:12:52.784198Z', 'shell.execute_reply': '2020-10-26T19:12:52.783812Z'}, slideshow={'slide_type': 'subslide'}}
# results_3 <- FindTopicsNumber(word_counts, 
#                             topics = seq(15, 35), 
#                             metrics = c("Griffiths2004", "CaoJuan2009", "Arun2010", "Deveaud2014"),
#                             method = "Gibbs", 
#                             control = list(seed = 912))
# saveRDS(results_3, file = assets("results_3.rds"))
results_3 <- readRDS(assets("results_3.rds"))
```

```{r execution={'iopub.execute_input': '2020-10-26T19:12:52.795909Z', 'iopub.status.busy': '2020-10-26T19:12:52.795321Z', 'iopub.status.idle': '2020-10-26T19:12:53.375392Z', 'shell.execute_reply': '2020-10-26T19:12:53.373992Z'}, slideshow={'slide_type': 'subslide'}}
FindTopicsNumber_plot(results_3)
```

<!-- #region slideshow={"slide_type": "slide"} -->
## Create model to be used
Models based on data as of Oct 12, 2020.
<!-- #endregion -->

```{r execution={'iopub.execute_input': '2020-10-26T19:12:53.383819Z', 'iopub.status.busy': '2020-10-26T19:12:53.382296Z', 'iopub.status.idle': '2020-10-26T19:12:53.450421Z', 'shell.execute_reply': '2020-10-26T19:12:53.449288Z'}}
# narratives_lda <- LDA(word_counts, method = "Gibbs", k = 23, control = list(seed = 912))
# saveRDS(narratives_lda, assets("narratives_lda.rds"))
narratives_lda <- readRDS(assets("narratives_lda.rds"))
narratives_lda
```

<!-- #region slideshow={"slide_type": "subslide"} -->
## Get betas and gammas 
<!-- #endregion -->

```{r execution={'iopub.execute_input': '2020-10-26T19:12:53.455614Z', 'iopub.status.busy': '2020-10-26T19:12:53.454148Z', 'iopub.status.idle': '2020-10-26T19:12:53.509519Z', 'shell.execute_reply': '2020-10-26T19:12:53.509097Z'}}
gammas <- tidy(narratives_lda, matrix = "gamma")
head(gammas)
```

```{r execution={'iopub.execute_input': '2020-10-26T19:12:53.524503Z', 'iopub.status.busy': '2020-10-26T19:12:53.523984Z', 'iopub.status.idle': '2020-10-26T19:12:53.556218Z', 'shell.execute_reply': '2020-10-26T19:12:53.554866Z'}, slideshow={'slide_type': 'subslide'}}
betas <- tidy(narratives_lda, matrix = "beta")
head(betas)
```

<!-- #region slideshow={"slide_type": "slide"} -->
## Save model
<!-- #endregion -->

```{r execution={'iopub.execute_input': '2020-10-26T19:12:53.561119Z', 'iopub.status.busy': '2020-10-26T19:12:53.559527Z', 'iopub.status.idle': '2020-10-26T19:12:53.733682Z', 'shell.execute_reply': '2020-10-26T19:12:53.733277Z'}}
saveRDS(betas, data_folder("betas.rds"))
```

```{r execution={'iopub.execute_input': '2020-10-26T19:12:53.752422Z', 'iopub.status.busy': '2020-10-26T19:12:53.751916Z', 'iopub.status.idle': '2020-10-26T19:12:53.805702Z', 'shell.execute_reply': '2020-10-26T19:12:53.804956Z'}, slideshow={'slide_type': 'subslide'}}
gammas <- narratives %>%
    mutate(incident_ID = as.character(incident_ID)) %>%
    select(incident_ID, ID, year, commodity, on_offshore) %>%
    right_join(gammas, by = c("incident_ID" = "document"))

head(gammas)
```

```{r execution={'iopub.execute_input': '2020-10-26T19:12:53.818487Z', 'iopub.status.busy': '2020-10-26T19:12:53.818024Z', 'iopub.status.idle': '2020-10-26T19:12:54.078195Z', 'shell.execute_reply': '2020-10-26T19:12:54.076932Z'}, slideshow={'slide_type': 'subslide'}}
saveRDS(gammas, data_folder("gammas.rds"))
```
